@* @page "/DisplayAllPills" *@
@model List<Pill>

@{
    ViewData["Title"] = "All Pills";
}

<h2 class="text-center mt-4">All Pills</h2>

<div class="container mt-4">
    <div class="row">
        @foreach (var pill in Model)
        {
            <input type="hidden" id="userId" value="@User.Identity.Name"/>

            <div class="col-md-4 mb-4">
                <div class="card">
                    @if (pill.ImageNumber == 1)
                    {
                        <img src="~/images/1.png" class="card-img-top" alt="@pill.Name"/>
                    }
                    @if (pill.ImageNumber == 2)
                    {
                        <img src="~/images/2.png" class="card-img-top" alt="@pill.Name"/>
                    }
                    @if (pill.ImageNumber == 3)
                    {
                        <img src="~/images/3.png" class="card-img-top" alt="@pill.Name"/>
                    }
                    @if (pill.ImageNumber == 4)
                    {
                        <img src="~/images/4.jpeg" class="card-img-top" alt="@pill.Name"/>
                    }
                    @if (pill.ImageNumber == 5)
                    {
                        <img src="~/images/5.jpeg" class="card-img-top" alt="@pill.Name"/>
                    }
                    @if (pill.ImageNumber == 6)
                    {
                        <img src="~/images/6.jpeg" class="card-img-top" alt="@pill.Name"/>
                    }
                    <div class="card-body">
                        <h5 class="card-title">@pill.Name</h5>
                        <p class="card-text">Price: $@pill.Price</p>
                        <p class="card-text">Count: <span class="available-count">@pill.AvailableCount</span></p>
                        <p class="card-text">Description: @pill.Description</p>
                        <p class="card-text">Provider Name: @pill.Provider</p>
                        <p class="card-text">City: @pill.PharmacyCity</p>
                        <p class="card-text">Pharmacy Number: @pill.PharmacyNumber</p>
                    </div>

                    <div class="card-footer d-flex justify-content-between">
                        <button class="btn btn-outline-danger add-to-favorites"
                                onclick="addToFavorites('@pill.Name', '@User.Identity.Name')"
                                data-product="@pill.Name">
                            <i class="fas fa-heart"></i> Add to Favorites
                        </button>

                        <input type="number" class="form-control btn btn-outline-danger btn-secondary count-input" placeholder="Enter Count"/>
                        <div class="input-group-append">
                            <button class="btn btn-outline-success" onclick="buyPill(this,'@pill.Name', '@pill.Price')">
                                <i class="fas fa-shopping-cart"></i> Buy
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
</div>
<script>
    function addToFavorites(productName, userName) {
            console.log("Adding product to favorites...");
        $.ajax({
            type: "POST",
            url: "/Account/AddToFavorites",
            data: { productName: productName, userName: userName }, 
            dataType: "json",
            success: function (result) {
                if (result.success) {
                    alert("Product added to favorites!");
                } else {
                    alert("Failed to add product to favorites.");
                }
            },
            error: function () {
                alert("An error occurred while adding the product to favorites.");
            }
        });
    }
     function buyPill(button,productName, productPrice) {

             var userName = $(button).closest('.card').find('.user-id').val();
             var count = $(button).closest('.card').find('.count-input').val();
             var countInt = parseInt(count);
             var availableCount = parseInt($(button).closest('.card').find('.available-count').text().trim());

               if (isNaN(countInt) || countInt <= 0 || countInt > availableCount) {
                    alert("Please enter a valid count within the available limit.");
                    return; // if count is invalid or exceeds available count
               }

            console.log("Buying product...");
            console.log("Count value: " + count);
            console.log("AVB count is : " + availableCount);
            $.ajax({
                type: "POST",
                url: "/Account/BuyPill",
                data: { productName: productName, userName: userName, count: count, productPrice: productPrice },
                dataType: "json",
                success: function (result) {
                    if (result.success) {
                        alert("Product added to cart!");
                    } else {
                        alert("Failed to add product to cart.");
                    }
                },
                error: function () {
                    alert("An error occurred while adding the product to cart.");
                }
            });
        }
    
</script>